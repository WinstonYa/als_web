<!DOCTYPE html>
<html xmlns:v-on="http://www.w3.org/1999/xhtml">
<head lang="en">
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <title>暂住人口</title>

    <link href="../../css/bootstrap@3.3.7/css/bootstrap.min.css" rel="stylesheet" type="text/css">

    <link rel="stylesheet" href="../../css/fonticon/iconfont.css">

    <!--
    <link href="../../../css/bootstrap@3.3.7/css/bootstrap.min.css" rel="stylesheet" type="text/css">-->
    <link href="../../alsm/ttyu.net/file/ttyu/css/ttyu.web.css" rel="stylesheet" type="text/css">

    <script src="../../alsm/ttyu.net/file/system/jq/jquery.min.js" type="text/javascript"></script>
    <script src="../../alsm/ttyu.net/file/system/jq/jquery-ui.js" type="text/javascript"></script>

    <script src="../../alsm/ttyu.net/file/system/bs/bootstrap.min.js" type="text/javascript"></script>

    <script src="../../alsm/ttyu.net/file/system/promise/es6-promise.js"></script>
    <script src="../../alsm/ttyu.net/file/system/promise/es6-promise.auto.js"></script>

    <!-- 必须先引入vue  后使用element-ui -->
    <script src="../../alsm/vue/vue.js"></script>

    <link href="../../alsm/element2.12.0/index.css" rel="stylesheet">
    <!-- <link href="../../css/elui/index.css" rel="stylesheet"> -->
    <!--    高版本ele ui-->
    <script src="../../alsm/element2.12.0/index.js"></script>
    <!-- <script src="../../alsm/elui/index.js"></script> -->

    <script src="../../alsm/api_sub.js" type="text/javascript"></script>

    <script src="../../js/config/config.js"></script>

    <style>
        .avatar-uploader .el-upload {
            border: 1px dashed #d9d9d9;
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            width: 200px
        }

        .avatar-uploader .el-upload:hover {
            border-color: #409EFF;
        }

        .avatar-uploader-icon {
            font-size: 28px;
            color: #8c939d;
            width: 150px;
            height: 200px;
            line-height: 200px;
            text-align: center;
        }

        .avatar {
            width: 200px;
            height: 200px;
            display: block;
        }

        .el-table .cell {
            white-space: nowrap;
        }

        .el-col {
            height: 48px;
        }
        .el-form-item__error {
            top: 50%;
            width: 80px;
            transform: translateY(-50%);
            padding: 0;
            /* text-align: center; */
            left: 210px;
            z-index: 999;
        }
        .el-upload__input {
            display: none !important;
        }
        #tableDiv{
            overflow: auto;
        }

        [v-cloak]{
            display:none;
        }

        .el-input.is-disabled .el-input__inner, .el-textarea.is-disabled .el-textarea__inner, .el-radio__input.is-disabled + span.el-radio__label {
            color:#606266;
        }
        .el-radio__input.is-disabled.is-checked .el-radio__inner {
            border-color: #409EFF;
            background: #409EFF;
        }
        .el-cascader:hover, .el-cascader-menu:hover {
            cursor: pointer;
        }
    </style>
</head>
<body>
<div id='body1' v-loading.fullscreen.lock="mainDiv"
     element-loading-text="拼命处理中"
     element-loading-spinner="el-icon-loading"
     element-loading-background="rgba(0, 0, 0, 0.5)">
    <div class="t-body">
        <div id="mainBody" style="display:none;">
            <div>
                <div class="t-find">
                    <div class="t-form">
                        <div>
                            <span style="margin-right: -25px;">派出所名称：</span>
                            <el-select v-model="params.dptId" clearable filterable placeholder="请选择派出所">
                                <el-option
                                        v-for="item in policeStation"
                                        :key="item.name"
                                        :label="item.name"
                                        :value="item.id">
                                </el-option>
                            </el-select>
                        </div>

                        <div style="margin-left: 10px;">
                            <span style="margin-right: -25px;">年龄段：</span>
                            <el-select v-model="ageRange" clearable style="width: 120px;">
                                <el-option
                                        v-for="item in ageOptions"
                                        :key="item.value"
                                        :label="item.label"
                                        :value="item.value">
                                </el-option>
                            </el-select>
                        </div>

                        <div style="margin-left: 10px;">
                            <span style="margin-right: -25px;">民族：</span>
                            <el-select v-model="params.nation" clearable filterable style="width: 120px;">
                                <el-option
                                        v-for="item in nationOptions"
                                        :key="item"
                                        :label="item"
                                        :value="item">
                                </el-option>
                            </el-select>
                        </div>

                        <div style="margin-left: 10px;">
                            <span style="margin-right: -25px;">注销情况：</span>
                            <el-select v-model="params.departureTimeState" clearable style="width: 120px;">
                                <el-option
                                        v-for="item in departureOptions"
                                        :key="item.value"
                                        :label="item.label"
                                        :value="item.value">
                                </el-option>
                            </el-select>
                        </div>

                        <div style="margin-left: 10px;">
                            <span style="margin-right: -10px;">姓名：</span>
                            <el-input v-model="params.name" clearable style="width: 140px;" placeholder="请输入"></el-input>
                        </div>
                        <div style="margin-left: 10px;">
                            <span>身份证号：</span>
                            <el-input v-model="params.idNumber" clearable style="width: 210px;" placeholder="请输入"></el-input>
                        </div>
                    </div>
                    <div class="t-btns">
                        <button title='查询'>
                            <span class="glyphicon glyphicon-search"></span>
                            查询
                        </button>
                        <button title='重置'>
                            <span class="glyphicon glyphicon-repeat"></span>
                            重置
                        </button>
                        <button
                            v-loading.fullscreen.lock="fullscreenLoading"
                            element-loading-text="拼命处理中"
                            element-loading-spinner="el-icon-loading"
                            element-loading-background="rgba(0, 0, 0, 0.8)"
                            @click="exportToExcel()">
                            <span class="iconfont icondaochu" style="font-size: 15px">导出</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="t-btnsDiv" style="border-top: 8px solid rgb(236, 240, 245) !important"></div>

            <div class="t-btns" style="background: #ffffff">
                <button title='新增'>
                    <span class="glyphicon glyphicon glyphicon-plus"></span>
                    新增
                </button>
                <button title='删除'>
                    <span class="glyphicon glyphicon-trash"></span>
                    删除
                </button>
            </div>

            <div id="tableDiv">
                <el-table :data="rows"
                    :row-key="rowKey"
                    ref="myTable"
                    @select='selectRows'
                    @select-all="selectRows"
                    border fit highlight-current-row style="width: 100%;"
                    :row-style="{height:'5px'}" :cell-style="{padding:'5px 0'}">

                    <el-table-column type="selection" align="center"  :reserve-selection="true">
                    </el-table-column>
                    <el-table-column align="center" label="序号" width="60">
                        <template slot-scope="scope">
                            {{  (pageIndex - 1) * pageSize +scope.$index+1 }}
                        </template>
                    </el-table-column>

                    <el-table-column align="center" label="操作" width="220">
                        <template slot-scope="scope">
                            <!-- <span v-on:click="show(scope.row)" style="cursor: pointer;color: #0e78c9">编辑</span> -->
                            <el-button size="mini" icon="el-icon-edit" @click="show(scope.row)" style="display:inline">编辑</el-button>
                            <el-button size="mini" type="primary" icon="el-icon-download" @click="exportToWord(scope.row.id, scope.row.name)">导出Word</el-button>
                            <!-- <el-button size="mini" icon="el-icon-search" @click="zfqkCheck(scope.row.id)">走访记录</el-button> -->
                        </template>
                    </el-table-column>

                    <el-table-column align="center" label="姓名" width="120">
                        <template slot-scope="scope">
                            <el-tooltip effect="light" :content="scope.row.name" placement="top">
                                <span>{{ scope.row.name }}</span>
                            </el-tooltip>
                        </template>
                    </el-table-column>

                    <el-table-column align="center" label="性别" width="50">
                        <template slot-scope="scope">
                            {{ scope.row.sex }}
                            <!-- <span v-if="scope.row.sex==1">男</span>
                            <span v-else >女</span> -->
                        </template>
                    </el-table-column>

                    <el-table-column align="center" label="电话" width="120">
                        <template slot-scope="scope">
                            {{ scope.row.phone }}
                        </template>
                    </el-table-column>

                    <el-table-column align="center" label="户籍地址" min-width="40*">
                        <template slot-scope="scope">
                            <el-tooltip effect="light" :content="scope.row.placeOfDomicile" placement="top">
                                <span>{{ scope.row.placeOfDomicile }}</span>
                            </el-tooltip>
                        </template>
                    </el-table-column>

                    <el-table-column align="center" label="暂住处所" min-width="20">
                        <template slot-scope="scope">
                            <el-tooltip effect="light" :content="scope.row.temporaryType" placement="top">
                                <span>{{ scope.row.temporaryType }}</span>
                            </el-tooltip>
                        </template>
                    </el-table-column>

                    <el-table-column align="center" label="拟居住期限" min-width="15">
                        <template slot-scope="scope">
                            {{ scope.row.dwellTerm }}
                        </template>
                    </el-table-column>

                    <el-table-column align="center" label="从事职业" width="80">
                        <template slot-scope="scope">
                            <el-tooltip effect="light" :content="scope.row.currentOccupation" placement="top">
                                <span>{{scope.row.currentOccupation}}</span>
                            </el-tooltip>
                        </template>
                    </el-table-column>

                    <el-table-column align="center" label="来本地日期" width="100px" min-width="15">
                        <template slot-scope="scope" v-if="scope.row.arrivalTime">
                            {{ getPartTime(scope.row.arrivalTime) }}
                            <!-- {{ scope.row.arrivalTime }} -->
                        </template>
                    </el-table-column>

                    <!--<el-table-column align="center" label="离开时间" min-width="15">
                        <template slot-scope="scope">
                            {{ scope.row.departureTime }}
                        </template>
                    </el-table-column>-->

                    <!-- <el-table-column align="center" label="走访记录" width="100">
                        <template slot-scope="scope">
                            <el-button size="small" type="info" @click="zfqkCheck(scope.row.id)">查看</el-button>
                        </template>
                    </el-table-column> -->
                </el-table>
            </div>

            <el-pagination
                    background
                    @size-change="handleSizeChange"
                    @current-change="handleCurrentChange"
                    :current-page="pageIndex"
                    :page-sizes="pageRows"
                    :page-size="pageSize"
                    layout="total,jumper,prev, pager, next,sizes"
                    :total="total"
                    style="margin-bottom: 15px">
            </el-pagination>
        </div>
        <!-- <el-dialog title="" center :visible.sync="dialogShow" top="3vh" style="height: 100%" width="80%" >
            解决了 el-dialog懒加载
            <div slot="footer" class="dialog-footer" style="position:relative;top: 15px;height:600px">
                <iframe style="width: 100%;height: 600px" id="mainIframe" ref="mainIframe" name="mainIframe" src="../wordHtml/TempPopulationWord.html" frameborder="0" scrolling="auto"></iframe>
            </div>
        </el-dialog> -->

        <el-dialog v-cloak title="人员详情" @close="closeDialog('row')" center :visible.sync="dialogShow" style="height: 100%;" top="3vh" width="952px" :fullscreen="fullscreen" >
            <el-form :model="row"  label-width="120px" class="demo-ruleForm" :rules="rules" ref="row">
                <div style="width: 100%;overflow: auto;height:100%;box-shadow: 0px 15px 10px -2px rgba(0, 0, 0, .04)">
                    <el-tabs type="border-card" v-model="activeName" @tab-click="handleClick">
                        <el-tab-pane label="个人信息" name="first">
                            <el-row>
                                <el-col :span="12">
                                    <el-row>
                                        <el-col :span="24">
                                            <el-form-item label="姓名:" >
                                                <el-input v-model="row.name" style="width: 200px;" :disabled="isReadOnly"></el-input>
                                            </el-form-item>
                                        </el-col>
                                    </el-row>
                                    <el-row>
                                        <el-col :span="24">
                                            <el-form-item label="别  名:">
                                                <el-input v-model="row.alias" style="width: 200px;" :disabled="isReadOnly"></el-input>
                                            </el-form-item>
                                        </el-col>
                                    </el-row>
                                    <el-row>
                                        <el-col :span="24">
                                            <el-form-item  label="性  别:" >
                                                <el-radio v-model="row.sex" label="男" :disabled="isReadOnly">男</el-radio>
                                                <el-radio v-model="row.sex" label="女" :disabled="isReadOnly">女</el-radio>
                                            </el-form-item>
                                        </el-col>
                                    </el-row>
                                    <el-row>
                                        <el-col :span="24">
                                            <el-form-item label="联系电话:" prop="phone">
                                                <el-input v-model="row.phone" style="width: 200px;" :disabled="isReadOnly"></el-input>
                                            </el-form-item>
                                        </el-col>
                                    </el-row>
                                </el-col>
                                <el-col :span="12" style="height: 210px;">
                                    <el-form-item label="照片：">
                                        <el-upload
                                            ref='upload' :disabled="isReadOnly"
                                            name="photographFile"
                                            class="avatar-uploader"
                                            :action="updateUrl"
                                            :http-request="httpRequest"
                                            :show-file-list="false"
                                            :on-success="handleAvatarSuccess"
                                            :before-upload="beforeAvatarUpload">
                                            <img v-if="imageUrl" :src="imageUrl" class="avatar">
                                            <i v-else class="el-icon-plus avatar-uploader-icon"></i>
                                        </el-upload>
                                    </el-form-item>
                                </el-col>
                            </el-row>

                            <el-row>
                                <el-col :span="12">
                                    <el-form-item  label="民  族:" >
                                        <el-select  v-model="row.nation" filterable placeholder="请选择" style="width: 200px;" :disabled="isReadOnly">
                                            <el-option
                                                v-for="item in nationOptions"
                                                :key="item"
                                                :label="item"
                                                :value="item">
                                            </el-option>
                                        </el-select>
                                    </el-form-item>
                                </el-col>
                                <el-col :span="12">
                                    <el-form-item label="兵役情况:" >
                                        <el-select v-model="row.militaryService" placeholder="请选择" style="width: 200px;" :disabled="isReadOnly">
                                            <el-option
                                                v-for="item in militaryOptions"
                                                :key="item"
                                                :label="item"
                                                :value="item">
                                            </el-option>
                                        </el-select>
                                    </el-form-item>
                                </el-col>
                            </el-row>

                            <el-row>
                                <el-col :span="12" >
                                    <el-form-item label="身份证号:" prop="idNumber">
                                        <el-input v-model="row.idNumber" style="width: 200px;" @input="idNumTransform(row.idNumber)" :disabled="isReadOnly"></el-input>
                                    </el-form-item>
                                </el-col>
                                <el-col :span="12">
                                    <el-form-item label="文化程度:" >
                                        <el-select v-model="row.education" placeholder="请选择" style="width: 200px;" :disabled="isReadOnly">
                                            <el-option
                                                v-for="item in cultureOptions"
                                                :key="item"
                                                :label="item"
                                                :value="item">
                                            </el-option>
                                        </el-select>
                                    </el-form-item>
                                </el-col>
                            </el-row>

                            <el-row>
                                <el-col :span="12">
                                    <el-form-item label="出生日期:" prop="birthday">
                                        <el-date-picker
                                            style="width: 200px;" :disabled="isReadOnly"
                                            value-format="yyyy-MM-dd"
                                            v-model="birthday"
                                            type="date"
                                            placeholder="选择日期">
                                        </el-date-picker>
                                    </el-form-item>
                                </el-col>
                                <el-col :span="12" >
                                    <el-form-item label="政治面貌:" >
                                        <el-select v-model="row.identity" placeholder="请选择" style="width: 200px;" :disabled="isReadOnly">
                                            <el-option
                                                v-for="item in politicsOptions"
                                                :key="item"
                                                :label="item"
                                                :value="item">
                                            </el-option>
                                        </el-select>
                                    </el-form-item>
                                </el-col>
                            </el-row>

                            <el-row>
                                <el-col :span="12">
                                    <el-form-item label="宗教信仰:" >
                                        <el-select v-model="row.religion" placeholder="请选择" style="width: 200px;" :disabled="isReadOnly">
                                            <el-option
                                                v-for="item in religionOptions"
                                                :key="item"
                                                :label="item"
                                                :value="item">
                                            </el-option>
                                        </el-select>
                                    </el-form-item>
                                </el-col>
                                <el-col :span="12">
                                    <el-form-item label="婚姻状况:" >
                                        <el-select v-model="row.maritalStatus" placeholder="请选择" style="width: 200px;" :disabled="isReadOnly">
                                            <el-option
                                                v-for="item in maritalStatusOptions"
                                                :key="item"
                                                :label="item"
                                                :value="item">
                                            </el-option>
                                        </el-select>
                                    </el-form-item>
                                </el-col>
                            </el-row>

                            <el-row>
                                <el-col :span="12">
                                    <el-form-item label="职业:" >
                                        <el-input v-model="row.profession" style="width: 200px;" :disabled="isReadOnly"></el-input>
                                    </el-form-item>
                                </el-col>
                                <el-col :span="12">
                                    <el-form-item label="从事本职业年限:" >
                                        <el-input v-model="row.term" style="width: 200px;" :disabled="isReadOnly"></el-input>
                                    </el-form-item>
                                </el-col>
                            </el-row>

                            <el-row>
                                <el-col :span="12">
                                    <el-form-item label="填报民警:" >
                                        <el-input readonly v-model="policeMan" style="width: 200px;" :disabled="isReadOnly"></el-input>
                                    </el-form-item>
                                </el-col>
                                <el-col :span="12">
                                    <el-form-item label="填报时间:" prop="writeTime">
                                        <el-date-picker
                                            style="width: 200px;" :disabled="isReadOnly"
                                            value-format="yyyy-MM-dd HH:mm:ss"
                                            v-model="row.writeTime"
                                            type="datetime"
                                            placeholder="选择日期时间">
                                        </el-date-picker>
                                    </el-form-item>
                                </el-col>
                            </el-row>

                            <el-row>
                                <el-col :span="24">
                                    <el-form-item label="户籍地址:" >
                                        <!-- <el-input v-model="row.placeOfDomicile" style="width: 636px;" :disabled="isReadOnly"></el-input> -->
                                        <el-cascader
                                            style="width: 636px;" :disabled="isReadOnly" clearable
                                            size="medium"
                                            v-model="nativePlaceArray"
                                            :options="nativePlaceList"
                                            :props="optionNativePlaceProps"
                                            @change="handleChange02">
                                        </el-cascader>
                                    </el-form-item>
                                </el-col>
                            </el-row>
                        </el-tab-pane>
                        <el-tab-pane label="暂住情况" name="second">
                            <el-row>
                                <el-col :span="12" >
                                    <el-form-item label="来本地日期:" prop="arrivalTime">
                                        <el-date-picker
                                            style="width: 100%;" :disabled="isReadOnly"
                                            value-format="yyyy-MM-dd"
                                            v-model="row.arrivalTime"
                                            type="date"
                                            placeholder="选择日期">
                                        </el-date-picker>
                                    </el-form-item>
                                </el-col>
                                <el-col :span="12">
                                    <el-form-item label="拟居住期限:" >
                                        <el-input v-model="row.dwellTerm" :disabled="isReadOnly"></el-input>
                                    </el-form-item>
                                </el-col>
                            </el-row>

                            <el-row>
                                <el-col :span="12">
                                    <el-form-item label="现服务处所:" >
                                        <el-input v-model="row.existingPremises" :disabled="isReadOnly"></el-input>
                                    </el-form-item>
                                </el-col>
                                <el-col :span="12">
                                    <el-form-item label="现从事职业:" >
                                        <el-input v-model="row.currentOccupation" :disabled="isReadOnly"></el-input>
                                    </el-form-item>
                                </el-col>
                            </el-row>

                            <el-row>
                                <el-col :span="24" style="height: 100%;">
                                    <el-form-item label="暂住处所及类型:" >
                                        <el-input
                                            type="textarea" :disabled="isReadOnly"
                                            :rows="2"
                                            v-model="row.temporaryType"
                                            placeholder="例：小区号楼**室（自购、租赁、单位等）">
                                        </el-input>
                                    </el-form-item>
                                </el-col>
                            </el-row>

                            <el-row>
                                <el-col :span="24" style="height: 100%;">
                                    <el-form-item label="暂住事由:" >
                                        <el-input
                                            type="textarea" :disabled="isReadOnly"
                                            :rows="2"
                                            v-model="row.stayFor">
                                        </el-input>
                                    </el-form-item>
                                </el-col>
                            </el-row>
                        </el-tab-pane>
                        <el-tab-pane label="跟踪管理" name="third">
                            <el-row>
                                <el-col :span="24">
                                    <el-form-item label="离开时间:">
                                        <el-date-picker
                                            style="width: 100%;" :disabled="isReadOnly"
                                            value-format="yyyy-MM-dd"
                                            v-model="row.departureTime"
                                            type="date"
                                            placeholder="选择日期">
                                        </el-date-picker>
                                    </el-form-item>
                                </el-col>
                            </el-row>

                            <el-row>
                                <el-col :span="24" style="height: 100%;">
                                    <el-form-item label="离开原因:">
                                        <el-input
                                            type="textarea" :disabled="isReadOnly"
                                            :rows="2"
                                            v-model="row.leaveReason">
                                        </el-input>
                                    </el-form-item>
                                </el-col>
                            </el-row>

                            <el-row>
                                <el-col :span="24" style="height: 100%;">
                                    <el-form-item label="去  向:">
                                        <el-input
                                            type="textarea" :disabled="isReadOnly"
                                            :rows="2"
                                            v-model="row.destination">
                                        </el-input>
                                    </el-form-item>
                                </el-col>
                            </el-row>

                            <el-row>
                                <el-col :span="24" style="height: 100%;">
                                    <el-form-item label="备注:" >
                                        <el-input
                                            type="textarea" :disabled="isReadOnly"
                                            :rows="2"
                                            v-model="row.remark">
                                        </el-input>
                                    </el-form-item>
                                </el-col>
                            </el-row>
                        </el-tab-pane>
                        <el-tab-pane label="走访记录" name="fourth" :disabled="isTrue">
                            <el-table :data="zfqkCheckTbaleRows"
                                border fit
                                highlight-current-row
                                style="width: 100%;"
                                :row-style="{height:'5px'}"
                                :cell-style="{padding:'5px 0'}">

                                <el-table-column align="center" label="序号" width="50">
                                    <template slot-scope="scope">
                                        {{ (zfqkCheckPageIndex - 1) * zfqkCheckPageSize +scope.$index+1 }}
                                    </template>
                                </el-table-column>

                                <el-table-column align="center" label="时间" width="170*">
                                    <template slot-scope="scope">
                                        {{ scope.row.visitingTime }}
                                    </template>
                                </el-table-column>

                                <el-table-column align="center" label="走访民警" min-width="10">
                                    <template slot-scope="scope">
                                        {{ scope.row.visitPoliceName }}
                                    </template>
                                </el-table-column>

                                <el-table-column align="center" label="操作" width="180">
                                    <template slot-scope="scope">
                                        <el-button size="small" type="info" @click="zfqkShowDetail(scope.row)">查看详情</el-button>
                                        <!-- <el-button size="small" type="danger" @click="deleteZfqkCheckShowDetail(scope.row.id)">删除</el-button> -->
                                    </template>
                                </el-table-column>
                            </el-table>

                            <el-pagination
                                background
                                @current-change="zfqkHandleCurrentChange"
                                :current-page="zfqkCheckPageIndex"
                                :page-size="zfqkCheckPageSize"
                                layout="total,jumper,prev, pager, next"
                                :total="zfqkChecktotal"
                                style="margin-bottom: 10px">
                            </el-pagination>
                        </el-tab-pane>
                    </el-tabs>
                </div>
            </el-form>

            <span slot="footer" class="dialog-footer">
                <el-button :style="{display:visible}" type="info" @click="dialogShow = false">取 消</el-button>
                <el-button :style="{display:visible}" type="success" @click="addRowSave('row')">提交</el-button>
            </span>
        </el-dialog>

        <el-dialog v-cloak title="走访情况"  center :visible.sync="oneZfqkDialog" top="3vh" :modal='false' style="height: 100%;" width="952px">
            <div style="width: 100%">
                <el-form :model="zfqkCheckTbaleRow"  label-width="120px" class="demo-ruleForm">
                    <el-row>
                        <el-col :span="12">
                            <el-form-item label="时间:">
                                <el-date-picker
                                    readonly
                                    style="width: 200px;"
                                    value-format="yyyy-MM-dd HH:mm:ss"
                                    v-model="zfqkCheckTbaleRow.visitingTime"
                                    type="datetime"
                                    placeholder="选择日期时间(必填)">
                                </el-date-picker>
                            </el-form-item>
                        </el-col>
                        <!-- <el-col :span="12">
                            <el-form-item label="走访对象:" >
                                <el-input v-model="zfqkCheckTbaleRow.visitObjectName"></el-input>
                            </el-form-item>
                        </el-col> -->
                        <el-col :span="12">
                            <el-form-item label="走访民警:" >
                                <el-input v-model="zfqkCheckTbaleRow.visitPoliceName" style="width: 200px;" readonly></el-input>
                            </el-form-item>
                        </el-col>
                    </el-row>

                    <el-row>
                        <el-col :span="24" style="height: 100%;">
                            <el-form-item label="走访记录:" >
                                <el-input
                                    style="width: 649px;"
                                    readonly
                                    type="textarea"
                                    :rows="3"
                                    v-model="zfqkCheckTbaleRow.workWordRecord">
                                </el-input>
                            </el-form-item>
                        </el-col>
                    </el-row>
                </el-form>
            </div>
        </el-dialog>
    </div>
</div>

</body>

</html>
<script type="text/javascript" src="../json/nation.js"></script>
<script type="text/javascript" src="../json/citys.js"></script>
<script src="../../js/utils/toExcel.js" type="text/javascript"></script>

<script type="text/javascript">
    $(function () {
        // 自定义验证规则
        var validateBirthday = function (rule, value, callback) {
            if (!value) {
                return callback(new Error('日期不能为空'));
            } else {
                callback();
            }
        };
        var validateIdNumber = function (rule, value, callback) {
            if (!value) {
                return callback(new Error('身份证号不能为空'));
            } else if (!checkIdNumber(value)) {
                callback(new Error('身份证号码错误!'));
            } else {
                callback();
            }
        };
        var validateArrivalTime = function (rule, value, callback) {
            if (!value) {
                return callback(new Error('来本地日期不能为空'));
            }else if (parseInt(vm.dateTransform(value)) <= parseInt(vm.dateTransform(vm.birthday))) {
                callback(new Error('来本地日期不能比年龄大!'));
            } else {
                callback();
            }
        };
        var validatePhoneNumber = function (rule, value, callback) {
            if (!value) {
                return callback(new Error('手机号不能为空'));
            } else if (!checkPhoneNumber(value)) {
                callback(new Error('手机号输入不正确!'));
            } else {
                callback();
            }
        };
        new Vue({
            el: '#body1',
            data: {
                params: {
                    page: '',
                    limit: '',
                    dptId: '',
                    nation: '',
                    name: '',
                    idNumber: '',
                    ageStart: '',
                    ageEnd: '',
                    departureTimeState: 2,
                },
                // 年龄选项
                ageOptions: [{
                    value: '0-18',
                    label: '0-18'
                }, {
                    value: '19-45',
                    label: '19-45'
                }, {
                    value: '45-以上',
                    label: '45-以上'
                }],
                // 注销选项
                departureOptions: [{
                    value: 1,
                    label: '已注销'
                }, {
                    value: 2,
                    label: '未注销'
                }],
                // 派出所名单
                policeStation: [],

                // 籍贯下拉选择框
                optionNativePlaceProps: {
                    value: 'label',
                    label: 'label',
                    children: 'children'
                },
                nativePlaceList: [],
                nativePlaceArray:[],

                ageRange: '',
                checked: false,
                selectedArray: [],
                options: [],
                dialogShow: false,

                rows: [],
                row: {},
                saveSelectRows: [],

                total: 0,
                pageIndex: 1,
                pageSize: 20,
                pageRows: [5, 10, 20, 30, 40, 50],

                oldMissionPersons: [],
                operationType: "",
                operated: '',

                //-----------------走访登记-------------
                zfqkCheckTbaleRowID: '',
                zfqkCheckTbaleRows: [],
                //单个显示
                zfqkCheckTbaleRow: {},
                zfqkChecktotal: 0,
                zfqkCheckPageIndex: 1,
                zfqkCheckPageSize: 10,
                zfqkDialog: false,
                oneZfqkDialog: false,

                //------
                activeName: 'first',
                sexOptions:[],
                nationOptions:[],
                religionOptions:[],
                maritalStatusOptions:[],
                militaryOptions:[],
                cultureOptions:[],
                politicsOptions:[],
                imageUrl:'',
                // updateUrl: params.serviceIp + '/RkglZzrkdjb/addDataAndFile',
                updateUrl: '#',
                fullscreenLoading:null,
                fullscreen:false,
                policeMan:'',
                visible:'none',
                isReadOnly: true,
                mainDiv:null,
                birthday: '',
                isTrue: true,

                // 验证规则
                rules: {
                    // birthday: [{ validator: validateBirthday, trigger: 'blur' }, { required: true, trigger: 'blur' }],
                    writeTime: [{ validator: validateBirthday, trigger: 'blur' }, { required: true, trigger: 'blur' }],
                    idNumber: [{ validator: validateIdNumber, trigger: 'blur' }, { required: true, trigger: 'blur' }],
                    arrivalTime: [{ validator: validateArrivalTime, trigger: 'blur' }, { required: true, trigger: 'blur' }],
                    phone: [{ validator: validatePhoneNumber, trigger: 'blur' }, { required: true, trigger: 'blur' }]
                }
            },
            mounted: function () {
                // vm = this;
                // vm.fillOptions();
                // vm.loadData();
                // initButton(this);

                var MapToId = window.location.search.substring(1);
                if (MapToId) {
                    vm.mainDiv = true;
                    vm.loadataOneDialog(MapToId);
                } else {
                    // vm.fillOptions();
                    vm.loadData();
                    initButton(this);
                    vm.visible = 'inline';
                    vm.isReadOnly = false;
                    $("#mainBody").css("display", "block");
                    vm.isTrue = false;
                }
            },
            computed: {},
            created: function () {
                vm = this;
                //多选框
                vm.sexOptions = sexOptions;
                vm.nationOptions = nation;
                vm.religionOptions = religionOptions;
                vm.maritalStatusOptions = maritalStatusOptions;
                vm.militaryOptions = military;
                vm.cultureOptions = cultureOptions;
                vm.politicsOptions = politicsOptions;
                vm.nativePlaceList = nativePlaceList;

                vm.loadData02();
                vm.setTableDiv();
            },
            methods: {
                httpRequest: function(data) {
                    let rd = new FileReader(); // 创建文件读取对象
                    let file = data.file;
                    rd.readAsDataURL(file); // 文件读取装换为base64类型
                    rd.onloadend = function (e) {
                        vm.imageUrl = this.result; // this指向当前方法onloadend的作用域
                    };
                },
                //加载单个dialog
                loadataOneDialog: function (MapToId) {
                    //隐藏关闭按钮
                    $(".el-dialog__close").css("display", "none");
                    $(".childDialog").height(800);
                    // $(".childDialog").css("height","800px")
                    doApi(
                        function (res) {
                            console.log(res)
                            if (res.status === 200) {
                                vm.fullscreen = true;
                                vm.birthday = vm.row.birthday;
                                vm.oldMissionPersons = [];
                                vm.selectedArray = [];
                                vm.row = res.data;
                                vm.operated = 'edit';

                                if (vm.row.photograph) {
                                    vm.imageUrl = vm.getShowUrl(vm.row.photograph);
                                }

                                //民警名称
                                if (vm.row.policeVisitForm != null) {
                                    // console.log(vm.row.policeVisitForm.fillPerson);
                                    vm.policeMan = vm.row.policeVisitForm.fillPerson;
                                }
                                if (vm.row.placeOfDomicile){
                                    vm.nativePlaceArray = vm.row.placeOfDomicile.split(",");
                                }
                                vm.dialogShow = true;
                            }
                        }, null, null, params.serviceIp + '/RkglZzrkdjb/' + MapToId,
                        "get"
                    );
                },
                handleChange02:function(e) {
                    if (e){
                        //地址 级联选择框
                        vm.row.placeOfDomicile = e.toString();
                    }
                },
                exportToExcel: function () {
                    vm.fullscreenLoading = true;
                    // var paramsPage={};
                    // paramsPage.page=1;
                    // paramsPage.limit=9999;
                    vm.params.limit = null;

                    var data3;
                    doApi(
                        function (res) {
                            if (res.status === 200) {
                                data3 = res.data.rows;
                                //处理日期
                                for (let i = 0; i < data3.length; i++) {
                                    if (data3[i].birthday) {
                                        data3[i].birthday = data3[i].birthday.substring(0, 10);
                                    }
                                }
                                // console.log(data3);
                                // 首行
                                // var title=['a','b','c','d','e','a','b','c','d','e','a','b','c','d','e','a','b','c','d','e','a','b','c','d','e','a','a','a']

                                //自定义过滤栏（不需要导出的行）
                                var filter = ['id', 'photograph', 'housePhotos', 'pointPositionInfo', 'policeVisitForm'];
                                let b = Json2Excel(data3, "暂住人口信息表", tempPopulation, filter);
                                if (b) {
                                    vm.fullscreenLoading = false;
                                }
                            }
                        }, null, null, params.serviceIp + '/RkglZzrkdjb/listUserDeptData',
                        "get", vm.params
                    );
                },
                exportToWord: function(id, name) {
                    var loading = this.$loading({
                        lock: true,
                        text: '下载中...',
                        spinner: 'el-icon-loading',
                        background: 'rgba(0, 0, 0, 0.7)'
                    });
                    var oReq = new XMLHttpRequest();
                    //判断是否IE浏览器
                    var isIE = !!window.ActiveXObject || "ActiveXObject" in window;
                    //url参数为拿后台数据的接口
                    var url = params.serviceIp + '/RkglZzrkdjb/exportWord?id=' + id;
                    oReq.open("get",url, true);
                    oReq.responseType = "blob";
                    oReq.onload = function (oEvent) {
                        var content = oReq.response;
                        //name为后台返给前端的文件名，后缀名必须加，后台有返回后缀就不用管，不然下载在本地不好打开。
                        var blob = new Blob([content]);
                        if(isIE){
                            window.navigator.msSaveOrOpenBlob(blob, name + '个人信息' + '.docx');
                        } else {
                            var elink = document.createElement('a');
                            elink.style.display = 'none';
                            elink.download = name + '个人信息' + '.docx';
                            elink.href = URL.createObjectURL(blob);
                            document.body.appendChild(elink);
                            elink.click();
                            document.body.removeChild(elink);
                        }
                        loading.close();
                    };
                    //请求头里放入用户口令，必须在.open()和.send()之间设置
                    var token = localStorage.getItem('token');
                    oReq.setRequestHeader('Authorization', token);
                    oReq.send();
                },
                //--------------------图片-------------------------
                handleAvatarSuccess: function (res, file) {
                    vm.imageUrl = URL.createObjectURL(file.raw);
                    vm.multfileImg = file.raw;
                },
                beforeAvatarUpload: function (file) {
                    vm.multfileImg = file;
                    const isJPG = file.type === 'image/jpeg';
                    const isPng = file.type === 'image/png';
                    if (!isJPG && !isPng) {
                        this.$message.error('上传图片格式只能为.jpg或.png!');
                    }
                    // const isLt10M = file.size / 1024 / 1024 < 10;
                    // if (!isLt10M) {
                    //     this.$message.error('上传头像图片大小不能超过 10MB!');
                    // }
                    return isJPG || isPng;
                },
                addRowSave:function(formName){
                    this.$refs[formName].validate(function (valid) {
                        if (valid) {
                            vm.row.birthday = vm.birthday;
                            this.fd = new FormData();
                            // console.log(vm.row);
                            for(var key in vm.row){
                                //key
                                // console.log(key);
                                // console.log(vm.row[key]);
                                //value
                                let value = vm.row[key];
                                if(key=='tjNeedyHouseholdsFamilies'){
                                }else if(key=='policeVisitForm'){
                                }
                                //不能传 数据库自动生成的时间，否则400
                                else if (key=='pointPositionInfo'){
                                }
                                else if (key=='rkglCzrkxxbFamilies'){
                                }
                                else {
                                    if (value != null) {
                                        this.fd.append(key, value);
                                    }
                                }
                            }

                            var userData = JSON.parse(window.localStorage.getItem('userdata'));
                            if (vm.policeStation.length ===1 && userData.dptName === vm.policeStation[0].name) {
                                this.fd.append('fillPersonId', userData.id)
                                this.fd.append('fillPerson', userData.name)
                            } else if (vm.row.policeVisitForm) {
                                this.fd.append('fillPersonId', vm.row.policeVisitForm.fillPersonId)
                                this.fd.append('fillPerson', vm.row.policeVisitForm.fillPerson)
                            }

                            //图片
                            if (vm.multfileImg != null) {
                                this.fd.append('photographFile', vm.multfileImg)
                            }

                            if (vm.operated=="add"){
                                doApiByFile(
                                    function(res) {
                                        vm.photographFile_url = res.data.photograph;
                                        if (res.status === 200) {
                                            // alert("成功")
                                            vm.dialogShow=false;
                                            vm.$message.info("新增成功！");
                                            vm.loadData();
                                        }else{
                                            vm.$message.error("新增失败！");
                                        }
                                    },
                                    function (res) {
                                        vm.$message.error(res.responseJSON.message);
                                    }, null,params.serviceIp + '/RkglZzrkdjb/addDataAndFile', 'post',this.fd
                                );
                            }else if (vm.operated=='edit'){
                                doApiByFile(
                                    function(res) {
                                        if (res.status === 200) {
                                            vm.loadData();
                                            vm.dialogShow=false;
                                            vm.$message.info("修改成功！");
                                        }else{
                                            vm.$message.error("修改失败！");
                                        }
                                    },
                                    function (res) {
                                        vm.$message.error(res.responseJSON.message);
                                    }, null,params.serviceIp + '/RkglZzrkdjb/updateDataAndFile', 'PUT',this.fd
                                );
                            }
                        } else {
                            return vm.$message.error("填报信息有缺失或错误！")
                        }
                    })
                },
                closeDialog:function(formName){
                    vm.imageUrl='';
                    vm.multfileImg = null;
                    vm.row={};
                    vm.nativePlaceArray = [];
                    vm.activeName = "first";
                    vm.loadData();
                    vm.$refs[formName].clearValidate();
                    vm.birthday = '';
                },
                handleClick: function (tab, event) {
                    // console.log(tab, event);
                    if (tab.name == 'fourth') {
                        vm.zfqkCheck(vm.row.id);
                    }
                },
                //----------------走访情况--------------
                /*addZfqkSave:function(){
                    // console.log(vm.zfqkCheckTbaleRow)
                    var form = new FormData();
                    //主表ID
                    form.append('visitObjectId', vm.zfqkCheckTbaleRowID)
                    //内容
                    form.append('visitObjectName', vm.zfqkCheckTbaleRow.visitObjectName)
                    // form.append('visitingTime',vm.zfqkCheckTbaleRow.visitingTime)
                    form.append('workWordRecord', vm.zfqkCheckTbaleRow.workWordRecord)
                    form.append('visitPoliceName', vm.zfqkCheckTbaleRow.visitPoliceName)
                    form.append('guardian', vm.zfqkCheckTbaleRow.guardian)

                    doApiByFile(
                        function (res) {
                            if (res.status === 200) {
                                vm.zfqkCheck(vm.zfqkCheckTbaleRowID);
                                vm.oneZfqkDialog = false;
                                parent.vm.showMessage("suc")
                            } else {
                                parent.vm.showMessage("fail")
                            }
                        },
                        null, null, params.serviceIp + '/TjKeyPersonVisit/addDataAndFile', 'post', form
                    );
                },
                addZfqk: function () {
                    vm.oneZfqkDialog = true;
                },
                deleteZfqkCheckShowDetail: function (id) {
                    doApi(
                        function (res) {
                            console.log(res);
                            if (res.status === 200) {
                                vm.zfqkCheck(vm.zfqkCheckTbaleRowID);
                                vm.$message.info("删除成功！");
                            } else {
                                vm.$message.error("删除失败！");
                            }
                        }, null, null, params.serviceIp + '/TjKeyPersonVisit/' + id,
                        "delete"
                    );
                },*/
                //显示单个表
                zfqkShowDetail: function (row) {
                    // console.log(row);
                    vm.zfqkCheckTbaleRow = row;
                    vm.oneZfqkDialog = true;
                },
                //切换页面
                zfqkHandleCurrentChange: function (zfqkCheckPageIndex) {
                    this.zfqkCheckPageIndex = zfqkCheckPageIndex;
                    this.zfqkCheck(vm.zfqkCheckTbaleRowID);
                },
                //表格 初始化
                zfqkCheck: function (id) {
                    vm.zfqkCheckTbaleRowID = id;
                    // console.log(id);
                    doApi(
                        function (res) {
                            // console.log(res);
                            if (res.status === 200) {
                                vm.zfqkCheckTbaleRows = res.data.rows;
                                vm.zfqkChecktotal = res.data.total;
                                // console.log("赋值完毕")
                            }
                        },null,null,params.serviceIp + '/TjKeyPersonVisit/page',
                        "get",{
                            'visitObjectId':vm.zfqkCheckTbaleRowID,
                            'visitObjectType':'人口管理_暂住人口登记',
                            'page':vm.zfqkCheckPageIndex,
                            'limit':vm.zfqkCheckPageSize
                        }
                    );
                },
                //---------------------------------------------
                //截取时间
                getPartTime: function (val) {
                    //let ti = val.split(' ');
                    //"2020-05-09 00:00:00"
                    var time = val.substring(0, 10);

                    /* var timearr = val.replace(/\:/g, "-").split("-");
                    var timestr = timearr[0]+"年"+ Number(timearr[1])+ "月" + timearr[2]+"日";*/

                    // console.log(4444,val)
                    return time;
                },
                rowKey: function (row) {
                    return row.id;
                },
                clearFilter: function () { // 清空全部筛选,必须放到方法中，否则加载失败
                    this.$refs.myTable.clearSelection();
                },
                selectAll: function () {
                    vm.selectedArray = [];
                    if (vm.checked) {
                        for (var i = 0; i < vm.options.length; i++) {
                            var item = vm.options[i];
                            vm.selectedArray.push(item.userId)
                        }
                    } else {
                        vm.selectedArray = [];
                    }
                },
                changeSelect: function (val) {
                    vm.selectedArray = val;
                },
                //将选中行数据存入变量
                selectRows: function (rows) {
                    vm.saveSelectRows = rows;
                },
                //填充下拉框
                /* fillOptions:function () {
                    doApi(
                        function (res) {
                            if(res.status === 200) {
                                vm.options= res.data;
                            }
                        },null,null,params.serviceIp + '/PoliceInfo/getCurrentUserPoliceInfo',
                        "get"
                    )
                },*/
                //初始化数据列表
                loadData: function () {
                    vm.params.page = vm.pageIndex;
                    vm.params.limit = vm.pageSize;
                    doApi(
                        function (res) {
                            // console.log(res);
                            if (res.status === 200) {
                                vm.rows = res.data.rows;
                                /*if (res.data.rows.arrivalTime){
                                    let partTime = vm.getPartTime(res.data.rows.arrivalTime);
                                    vm.rows.arrivalTime=partTime;
                                }*/
                                vm.total = res.data.total;
                            }
                        }, null, null, params.serviceIp + '/RkglZzrkdjb/listUserDeptData',
                        "get", vm.params
                    );
                },
                setTableDiv:function(){
                    var height=$(window).height()-200;
                    $("#tableDiv").css("height",height);
                },
                //初始化派出所列表
                loadData02: function () {
                    doApi(
                        function (res) {
                            if (res.status === 200) {
                                vm.policeStation = res.data;
                            }
                        }, null, null, params.serviceIp + '/PoliceInfo/getCurrentUserPoliceStation', "get"
                    );
                },
                //分页 初始页pageIndex、控制每页几条
                handleSizeChange: function (size) {
                    this.pageSize = size;
                    this.loadData();
                },
                // 控制页面的切换
                handleCurrentChange: function (pageIndex) {
                    this.pageIndex = pageIndex;
                    this.loadData();
                },
                isProgress: function (startTime, endTime) {
                    if (startTime == null || endTime == null) {
                        return true;
                    }
                    var now = new Date();
                    if (now < new Date(startTime.replace(/-/g, "/")) || now > new Date(endTime.replace(/-/g, "/"))) {
                        return false;
                    }
                    return true;
                },
                getTagColor: function (score) {
                    if (score == 1) {
                        return "success";
                    } else if (score == 0) {
                        return "danger";
                    }
                    return "info";
                },
                show: function (row) { //获取点击对象
                    // console.log(row)
                    vm.oldMissionPersons=[];
                    vm.selectedArray=[];
                    vm.row=row;
                    vm.birthday = vm.row.birthday;
                    vm.operated='edit';

                    if (vm.params.departureTimeState === 1) {
                        vm.visible = 'none';
                        vm.isReadOnly = true;
                    } else {
                        vm.visible = 'inline';
                        vm.isReadOnly = false;
                    }

                    if (row.photograph) {
                        vm.imageUrl = vm.getShowUrl(row.photograph);
                    }
                    if (row.placeOfDomicile){
                        vm.nativePlaceArray = row.placeOfDomicile.split(",");
                    }
                    //民警名称
                    // console.log(vm.row.policeVisitForm.fillPerson);
                    vm.policeMan = vm.row.policeVisitForm.fillPerson;
                    vm.dialogShow = true;
                },
                deleteList: function () {
                    vm.$confirm('此操作将永久删除该文件, 是否继续?', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(function () {
                        var delIds=[];
                        for ( var i=0;i<vm.saveSelectRows.length;i++ ){
                            var row=vm.saveSelectRows[i];
                            delIds.push(row.id);
                        }

                        doApiByJsonstr(
                            function(res) {
                                if (res.status === 200) {
                                    vm.pageIndex=1;
                                    vm.loadData();
                                    vm.dialogShow=false;
                                    vm.clearFilter();
                                    vm.$message.info("批量删除成功！");
                                }else{
                                    vm.$message.error("批量删除失败！");
                                }
                            },
                            null, null, params.serviceIp + '/RkglZzrkdjb/batchDelete', 'post',delIds
                        );
                    }).catch(function () {
                        vm.$message({
                            type: 'info',
                            message: '已取消删除'
                        });
                    });
                },
                showMessage: function (status) {
                    if (status == 'suc') {
                        vm.$message.info("操作成功！");
                    }
                    if (status == 'fail') {
                        vm.$message.error("操作失败！");
                    }
                },
                // 转换日期
                dateTransform: function(val) {
                    return val.slice(0, 10).replace('-', '').replace('-', '')
                },
                // 自动根据身份证号码填入出生日期
                idNumTransform: function(num) {
                    if (num.length >= 14) {
                        var date = num.slice(6, 10) + '-' + num.slice(10, 12) + '-' + num.slice(12, 14);
                        vm.birthday = date;
                        vm.row.birthday = vm.birthday;
                    }
                },
                // 获取压缩路径图片、音频或视频
                getShowUrl:function (oldUrl) {
                    if (oldUrl){
                        //将url的ip换成服务器的ip
                        var showUrl=urlChangeIp(oldUrl,params.serviceIp);
                        //选择展示的url
                        var url=getThumbnail(showUrl);
                        if(isExistUrl(url)){
                            return url;
                        } else {
                            if(isExistUrl(showUrl)){
                                return showUrl;
                            }else {
                                return params.serviceIp + params.pictureLoadingFailedUrl;
                            }
                        }
                    }
                    return null;
                },
            }
        })
    })
</script>
<script type="text/javascript">
    function initButton(vm) {
        $('button').on("click", function (e) {
            switch (this.innerText.trim()) {
                case "重置":
                    // vm.params.dptId=null;
                    vm.ageRange='';
                    // vm.params.nation=null;
                    // vm.params.name=null;
                    // vm.params.idNumber=null;
                    vm.params={};
                    break;
                case "查询":
                    vm.pageIndex = 1;
                    vm.params.ageStart = parseInt(vm.ageRange.split('-')[0]) ? parseInt(vm.ageRange.split('-')[0]) : null;
                    vm.params.ageEnd = parseInt(vm.ageRange.split('-')[1]) ? parseInt(vm.ageRange.split('-')[1]) : null;
                    vm.loadData();
                    break;
                case "新增":
                    // var nullDate ='';
                    // const obj1 = $("#mainIframe")[0].contentWindow;
                    var userData = JSON.parse(window.localStorage.getItem('userdata'));
                    vm.policeMan = userData.name;
                    vm.operated='add';
                    // obj1.setData(vm.operated);
                    vm.dialogShow = true;
                    break;
                case "删除":
                    vm.deleteList();
                    break;
                case "关闭":
                    break;
            }
        });
    }
</script>
